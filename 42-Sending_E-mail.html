
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="LibreOffice Programming (LO-P) is intended for programmers who want  to learn how to use the the LibreOffice API. This allows programs to control  and manipulate LibreOffice's text, drawing, presentation, spreadsheet, and  database applications, and a lot more (e.g. its spell checker, forms  designer, and charting tools).  ">
      
      
      
      
      <link rel="icon" href="assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-7.3.4">
    
    
      
        <title>Chapter 42. Sending E-mail - LibreOffice Programming</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.db9e7362.min.css">
      
        
        <link rel="stylesheet" href="assets/stylesheets/palette.3f5d1f46.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
      <link rel="stylesheet" href="css/extra.css">
    
    
      


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="preference" data-md-color-primary="" data-md-color-accent="">
  
    
    <script>function __prefix(e){return new URL(".",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#chapter-42-sending-e-mail" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="index.html" title="LibreOffice Programming" class="md-header__button md-logo" aria-label="LibreOffice Programming" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            LibreOffice Programming
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Chapter 42. Sending E-mail
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/flywire/lo-p/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    lo-p
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="index.html" title="LibreOffice Programming" class="md-nav__button md-logo" aria-label="LibreOffice Programming" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    LibreOffice Programming
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/flywire/lo-p/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    lo-p
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="index.html" class="md-nav__link">
        Preface
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="01%20Part%201%20Basics.html" class="md-nav__link">
        Part 1 Basics
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="01-Concepts.html" class="md-nav__link">
        Chapter 1. LibreOffice API Concepts
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="02-Starting_and_Stopping.html" class="md-nav__link">
        Chapter 2. Starting and Stopping
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="03-Examining.html" class="md-nav__link">
        Chapter 3. Examining
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="04-Listening.html" class="md-nav__link">
        Chapter 4. Listening, and Other Techniques
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="05%20Part%202%20Writer.html" class="md-nav__link">
        Part 2 Writer
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="05-Text_API_Overview.html" class="md-nav__link">
        Chapter 5. Text API Overview
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="06-Text_Styles.html" class="md-nav__link">
        Chapter 6. Text Styles
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="07-Non-text_Content.html" class="md-nav__link">
        Chapter 7. Text Content Other than Strings
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="08-Graphic_Content.html" class="md-nav__link">
        Chapter 8. Graphic Content
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="09-Text_Search.html" class="md-nav__link">
        Chapter 9. Text Search and Replace
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="10-Linguistics.html" class="md-nav__link">
        Chapter 10. The Linguistics API
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="11%20Part%203%20Draw%20%26%20Impress.html" class="md-nav__link">
        Part 3 Draw & Impress
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="11-Draw_Impress_APIs.html" class="md-nav__link">
        Chapter 11. Draw/Impress APIs Overview
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="12-Examining_DrawImpress.html" class="md-nav__link">
        Chapter 12. Examining a Draw/Impress Document
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="13-Basic_Shapes.html" class="md-nav__link">
        Chapter 13. Drawing Basic Shapes
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="14-Animation.html" class="md-nav__link">
        Chapter 14. Animation
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="15-Complex_Shapes.html" class="md-nav__link">
        Chapter 15. Complex Shapes
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="16-Making_Slides.html" class="md-nav__link">
        Chapter 16. Making Slides
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="17-Slide_Deck_Manipulation.html" class="md-nav__link">
        Chapter 17. Slide Deck Manipulation
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="18-Slide_Shows.html" class="md-nav__link">
        Chapter 18. Slide Shows
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="19%20Part%204%20Calc.html" class="md-nav__link">
        Part 4 Calc
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="19-Calc_API_Overview.html" class="md-nav__link">
        Chapter 19. Calc API Overview
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="20-Spreadsheet_Manipulation.html" class="md-nav__link">
        Chapter 20. Spreadsheet Displaying and Creation
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="21-Extracting_Data.html" class="md-nav__link">
        Chapter 21. Extracting Data
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="22-Styles.html" class="md-nav__link">
        Chapter 22. Styles
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="23-Garlic_Secrets.html" class="md-nav__link">
        Chapter 23. Garlic Secrets
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="24-Complex_Data_Manipulation.html" class="md-nav__link">
        Chapter 24. Complex Data Manipulation
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="25-Monitoring_Sheets.html" class="md-nav__link">
        Chapter 25. Monitoring Sheets
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="26-Search_Replace.html" class="md-nav__link">
        Chapter 26. Search and Replace
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="27-Funcs_Analysis.html" class="md-nav__link">
        Chapter 27. Functions and Data Analysis
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="28%20Part%205%20Chart.html" class="md-nav__link">
        Part 5 Chart
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="28-Chart2_API_Overview.html" class="md-nav__link">
        Chapter 28. Chart2 API Overview
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="29-Column_Charts.html" class="md-nav__link">
        Chapter 29. Column Charts
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="30-Bar_Pie_Area_Line_Charts.html" class="md-nav__link">
        Chapter 30. Bar, Pie, Area, Line Charts
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="31-XY_Scatter_Charts.html" class="md-nav__link">
        Chapter 31. XY (Scatter) Charts
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="32-Bubble_Net_Stock_Charts.html" class="md-nav__link">
        Chapter 32. Bubble, Net, Stock Charts
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="33-Charts_in_Others_Docs.html" class="md-nav__link">
        Chapter 33. Using Charts in Other Documents
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="34%20Part%206%20Base.html" class="md-nav__link">
        Part 6 Base
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="34-JDBC_to_Base_API.html" class="md-nav__link">
        Chapter 34. From JDBC to the Base API
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="35-Examining_Base_Docs.html" class="md-nav__link">
        Chapter 35. Examining Base Documents
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="36-RowSets_DB_Context.html" class="md-nav__link">
        Chapter 36. Using RowSets and Database Context
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="37-Driver_Manager.html" class="md-nav__link">
        Chapter 37. Using the Driver Manager
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="38-ODB_as_Zip.html" class="md-nav__link">
        Chapter 38. Treating an ODB File as a Zipped Folder
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="39%20Part%207%20Cross-application.html" class="md-nav__link">
        Part 7 Cross-application
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="39-Forms_API_Overview.html" class="md-nav__link">
        Chapter 39. Forms API Overview
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="40-Building_a_Form.html" class="md-nav__link">
        Chapter 40. Building a Form Programmatically
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="41-Printing.html" class="md-nav__link">
        Chapter 41. Printing
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Chapter 42. Sending E-mail
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="42-Sending_E-mail.html" class="md-nav__link md-nav__link--active">
        Chapter 42. Sending E-mail
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-simplesystemmailsimplecommandmail" class="md-nav__link">
    1.  SimpleSystemMail/SimpleCommandMail
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-using-the-mailserviceprovider-service" class="md-nav__link">
    2.  Using the MailServiceProvider Service
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-using-javamail" class="md-nav__link">
    3.  Using JavaMail
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-the-desktop-api" class="md-nav__link">
    4.  The Desktop API
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-thunderbird-scripting" class="md-nav__link">
    5.  Thunderbird Scripting
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-office-mail-merge" class="md-nav__link">
    6.  Office Mail Merge
  </a>
  
    <nav class="md-nav" aria-label="6.  Office Mail Merge">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#61-preparing-the-mail-merge-inputs" class="md-nav__link">
    6.1.  Preparing the Mail Merge Inputs
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#62-programming-the-mail-merge" class="md-nav__link">
    6.2.  Programming the Mail Merge
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#63-specializing-the-merge" class="md-nav__link">
    6.3.  Specializing the Merge
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#64-mergetask-implementing-mail-merging" class="md-nav__link">
    6.4.  mergeTask(): Implementing Mail Merging
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#65-mail-merge-reliability" class="md-nav__link">
    6.5.  Mail Merge Reliability
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="43-Using_the_Clipboard.html" class="md-nav__link">
        Chapter 43. Using the Clipboard
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="44-Office_as_GUI_Comp.html" class="md-nav__link">
        Chapter 44. Office as a GUI Component
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="45%20Part%208%20Extending%20LibreOffice.html" class="md-nav__link">
        Part 8 Extending LibreOffice
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="45-UNO_Components.html" class="md-nav__link">
        Chapter 45. Coding UNO Components
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="46-Addons.html" class="md-nav__link">
        Chapter 46. Add-ons
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="47-Calc_Add-ins.html" class="md-nav__link">
        Chapter 47. Calc Add-ins
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="48-Event_Macros.html" class="md-nav__link">
        Chapter 48. Event Macros
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="49-Ext_Doc_Event_Macros.html" class="md-nav__link">
        Chapter 49. Extension and Document Event Macros
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="50%20Part%209%20The%20ODF%20Format.html" class="md-nav__link">
        Part 9 The ODF Format
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="50-Importing_XML.html" class="md-nav__link">
        Chapter 50. Importing XML
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="51-Simple_ODF.html" class="md-nav__link">
        Chapter 51. Simple ODF
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-simplesystemmailsimplecommandmail" class="md-nav__link">
    1.  SimpleSystemMail/SimpleCommandMail
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-using-the-mailserviceprovider-service" class="md-nav__link">
    2.  Using the MailServiceProvider Service
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-using-javamail" class="md-nav__link">
    3.  Using JavaMail
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-the-desktop-api" class="md-nav__link">
    4.  The Desktop API
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-thunderbird-scripting" class="md-nav__link">
    5.  Thunderbird Scripting
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-office-mail-merge" class="md-nav__link">
    6.  Office Mail Merge
  </a>
  
    <nav class="md-nav" aria-label="6.  Office Mail Merge">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#61-preparing-the-mail-merge-inputs" class="md-nav__link">
    6.1.  Preparing the Mail Merge Inputs
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#62-programming-the-mail-merge" class="md-nav__link">
    6.2.  Programming the Mail Merge
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#63-specializing-the-merge" class="md-nav__link">
    6.3.  Specializing the Merge
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#64-mergetask-implementing-mail-merging" class="md-nav__link">
    6.4.  mergeTask(): Implementing Mail Merging
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#65-mail-merge-reliability" class="md-nav__link">
    6.5.  Mail Merge Reliability
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/flywire/lo-p/edit/master/docs/42-Sending_E-mail.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="chapter-42-sending-e-mail">Chapter 42. Sending E-mail<a class="headerlink" href="#chapter-42-sending-e-mail" title="Permanent link">&para;</a></h1>
<div class="admonition note">
<p class="admonition-title">Topics</p>
<p>SimpleSystemMail /
SimpleCommandMail;
Using the
MailServiceProvider
Service; Using
JavaMail; The Desktop
API; Thunderbird
Scripting; Office Mail
Merge</p>
<p>Example folders: "Mail
Tests" and "Utils"</p>
</div>
<p>The Jargon file is a humorous collection of computer
slang (online at <a href="http://www.catb.org/jargon/html/">http://www.catb.org/jargon/html/</a>), and its
entry for Zawinski's "Law of Software Envelopment"
(<a href="http://www.catb.org/jargon/html/Z/Zawinskis-Law.html">http://www.catb.org/jargon/html/Z/Zawinskis-Law.html</a>)
came to mind while I was preparing this chapter. It states:</p>
<blockquote>
<p>"Every program attempts to expand until it can
read mail. Those programs which cannot so
expand are replaced by ones which can."</p>
</blockquote>
<p>Office is a reasonable example (if you replace 'read' with 'send') because, depending
on how you count things, its API contains three different ways of sending e-mail. If
you program in Java, the number increases to six! These approaches are summarized
in Table 1, and none are without drawbacks.</p>
<table>
<thead>
<tr>
<th>API</th>
<th>Services/Classes Used</th>
<th>Drawbacks</th>
</tr>
</thead>
<tbody>
<tr>
<td>Office API</td>
<td>SimpleSystemMail or</td>
<td>User must click "Ok" in a "Confirm"</td>
</tr>
<tr>
<td>(coded in Java)</td>
<td>SimpleCommandMail</td>
<td>dialog before the e-mail is sent.</td>
</tr>
<tr>
<td></td>
<td>MailServiceProvider</td>
<td>Two DLLs must be repositioned in the</td>
</tr>
<tr>
<td></td>
<td>(joint best choice)</td>
<td>Office installation before the code will</td>
</tr>
<tr>
<td></td>
<td></td>
<td>work.</td>
</tr>
<tr>
<td></td>
<td></td>
<td>Firewalls may block it.</td>
</tr>
<tr>
<td></td>
<td>MailMerge</td>
<td>Works well, but focuses on mail</td>
</tr>
<tr>
<td></td>
<td></td>
<td>merge rather than general purpose e-</td>
</tr>
<tr>
<td></td>
<td></td>
<td>mail.</td>
</tr>
<tr>
<td></td>
<td></td>
<td>The user must configure Office's e-</td>
</tr>
<tr>
<td></td>
<td></td>
<td>mail settings in Writer before the code</td>
</tr>
<tr>
<td></td>
<td></td>
<td>will work.</td>
</tr>
<tr>
<td>Java only</td>
<td>JavaMail: Session,</td>
<td>Requires the download of the</td>
</tr>
<tr>
<td>(no use of Office)</td>
<td>Message, Transport, and</td>
<td>javax.mail JAR.</td>
</tr>
<tr>
<td></td>
<td>others (joint best</td>
<td>Firewalls may block it.</td>
</tr>
<tr>
<td></td>
<td>choice)</td>
<td></td>
</tr>
<tr>
<td></td>
<td>Desktop.mail()</td>
<td>Attachments are not supported as</td>
</tr>
<tr>
<td></td>
<td></td>
<td>standard in the mailto: protocol.</td>
</tr>
<tr>
<td></td>
<td></td>
<td>The e-mail client appears, and the user</td>
</tr>
<tr>
<td></td>
<td></td>
<td>must press "Send".</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>Process &amp; batch file</td>
<td>Needs a separate batch file.</td>
</tr>
<tr>
<td></td>
<td></td>
<td>Tied to the Thunderbird e-mail client.</td>
</tr>
<tr>
<td></td>
<td></td>
<td>The e-mail client appears, and the user</td>
</tr>
<tr>
<td></td>
<td></td>
<td>must press "Send".</td>
</tr>
</tbody>
</table>
<p>Table 1. Office and Java Approaches for Sending E-mail.</p>
<p>My aim is to write a sendMessage() function that sends a text message, optionally
including a file attachment, to a specified e-mail address. The mail will be sent
through an SMTP (Simple Mail Transfer Protocol) server that uses STARTTLS to
encrypt the link. I've tested the code using my local departmental server, and with my
Gmail account.</p>
<p>One surprising entry in Table 1 is Office's mail merge, which typically utilizes a
Writer template file and a spreadsheet (or database) to generate form letters addressed
to different people. These letters can be saved to files, sent to a printer, or posted out
as e-mail attachments. It's the last alternative that led me to include mail merging in
this chapter.</p>
<p>Table 1 identifies two "joint best choice" approaches for sending e-mail. If the mail-
out is part of other Office-related tasks, such as the run-time generation of a
document, then its best to use Office's MailServiceProvider service since it nicely
integrates with the rest of the API. However, if you plan to write a standalone e-mail
application which loads and sends ODF attachments, then JavaMail has more features
(<a href="https://java.net/projects/javamail/pages/Home">https://java.net/projects/javamail/pages/Home</a>).</p>
<p>I'll start this chapter by explaining the Office services for sending e-mail:
SimpleSystemMail/SimpleCommandMail, and the newer MailServiceProvider. Then
I'll switch to non-Office approaches, looking first at JavaMail, followed by two
techniques which don't need an extra JAR file but do require the user to interact with
the OSes e-mail client. I'll finish with mail merge in Office.</p>
<h2 id="1-simplesystemmailsimplecommandmail">1.  SimpleSystemMail/SimpleCommandMail<a class="headerlink" href="#1-simplesystemmailsimplecommandmail" title="Permanent link">&para;</a></h2>
<p>The SimpleSystemMail and SimpleCommandMail services in the system module
send e-mail using the OSes default e-mail client. They both implement the same
interfaces, but SimpleSystemMail is for Windows, and SimpleCommandMail for
Linux and MacOS. Figure 1 shows the services and some of their interfaces.</p>
<p><img alt="" src="images/42-Sending_E-mail-1.png" /></p>
<p>Figure 1. The SimpleSystemMail and SimpleCommandMail Services.</p>
<p>By utilizing the machine's e-mail client, the services don't need the programmer to
enter the mail server address, its port, and a login and password, since this
information is in the client's account settings (or user profile). A drawback of this
approach is that the message passes through the client's GUI, and the user must press
a "Send" button (or equivalent) to post the message. Fortunately, XSimpleMailClient
lets the user interface be mostly hidden, but a "Confirm" dialog like the one in Figure
2 still pops up.</p>
<p><img alt="" src="images/42-Sending_E-mail-2.png" /></p>
<p>Figure 2.  The "Confirm" Dialog when using
SimpleSystemMail/SimpleCommandMail.</p>
<p>This dialog can be disabled via the checkbox shown in Figure 2, but that's a bad idea
from a security viewpoint.</p>
<p>SimpleSystemMail and SimpleCommandMail are utilized by sendEmailByClient() in
my Mail.java utility class:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// in the Mail class</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">sendEmailByClient</span><span class="p">(</span><span class="n">String</span> <span class="n">to</span><span class="p">,</span> <span class="n">String</span> <span class="n">subject</span><span class="p">,</span>
                                      <span class="n">String</span> <span class="n">body</span><span class="p">,</span> <span class="n">String</span> <span class="n">fnm</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Sending e-mail by client...&quot;</span><span class="p">);</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="n">XSimpleMailClientSupplier</span> <span class="n">mcSupp</span> <span class="o">=</span>
        <span class="n">Lo</span><span class="p">.</span><span class="na">createInstanceMCF</span><span class="p">(</span><span class="n">XSimpleMailClientSupplier</span><span class="p">.</span><span class="na">class</span><span class="p">,</span>
                    <span class="s">&quot;com.sun.star.system.SimpleSystemMail&quot;</span><span class="p">);</span>
                       <span class="c1">// windows e-mail client service</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">mcSupp</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">mcSupp</span> <span class="o">=</span> <span class="n">Lo</span><span class="p">.</span><span class="na">createInstanceMCF</span><span class="p">(</span>
                     <span class="n">XSimpleMailClientSupplier</span><span class="p">.</span><span class="na">class</span><span class="p">,</span>
                     <span class="s">&quot;com.sun.star.system.SimpleCommandMail&quot;</span><span class="p">);</span>
                   <span class="c1">// returns null on Windows; used on Linux/Mac</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">mcSupp</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Unable to create client&quot;</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">XSimpleMailClient</span> <span class="n">mc</span> <span class="o">=</span> <span class="n">mcSupp</span><span class="p">.</span><span class="na">querySimpleMailClient</span><span class="p">();</span>
                    <span class="c1">// defaults to ThunderBird on my OS</span>

    <span class="n">XSimpleMailMessage</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">mc</span><span class="p">.</span><span class="na">createSimpleMailMessage</span><span class="p">();</span>
    <span class="n">msg</span><span class="p">.</span><span class="na">setRecipient</span><span class="p">(</span><span class="n">to</span><span class="p">);</span>
    <span class="n">msg</span><span class="p">.</span><span class="na">setSubject</span><span class="p">(</span><span class="n">subject</span><span class="p">);</span>

    <span class="n">XSimpleMailMessage2</span> <span class="n">msg2</span> <span class="o">=</span> <span class="n">Lo</span><span class="p">.</span><span class="na">qi</span><span class="p">(</span><span class="n">XSimpleMailMessage2</span><span class="p">.</span><span class="na">class</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
    <span class="n">msg2</span><span class="p">.</span><span class="na">setBody</span><span class="p">(</span><span class="n">body</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">fnm</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">String</span><span class="o">[]</span> <span class="n">attachs</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="p">;</span>
      <span class="n">attachs</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="n">FileIO</span><span class="p">.</span><span class="na">getAbsolutePath</span><span class="p">(</span><span class="n">fnm</span><span class="p">);</span>  <span class="c1">// attachment</span>
      <span class="n">msg</span><span class="p">.</span><span class="na">setAttachement</span><span class="p">(</span><span class="n">attachs</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">mc</span><span class="p">.</span><span class="na">sendSimpleMailMessage</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span>
                   <span class="n">SimpleMailClientFlags</span><span class="p">.</span><span class="na">NO_USER_INTERFACE</span><span class="p">);</span>
         <span class="c1">// hides GUI but still displays a &quot;Confirm&quot; dialog</span>
  <span class="p">}</span>
  <span class="k">catch</span><span class="p">(</span><span class="n">com</span><span class="p">.</span><span class="na">sun</span><span class="p">.</span><span class="na">star</span><span class="p">.</span><span class="na">uno</span><span class="p">.</span><span class="na">Exception</span> <span class="n">e</span><span class="p">)</span>
  <span class="p">{</span>  <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>  <span class="p">}</span>
<span class="p">}</span>  <span class="c1">// end of sendEmailByClient()</span>
</code></pre></div>
<p>The function first tries to instantiate the Windows SimpleSystemMail service, which
returns null on a Linux/Mac platform, and then switches to SimpleCommandMail
(which returns null on Windows). The resulting XSimpleMailClientSupplier instance
is used to obtain a reference to the system's default e-mail client, as represented by
XSimpleMailClient.</p>
<p>An XSimpleMailMessage object is initialized with the recipient, subject line, body
text, and optionally attached file. One of the quirks of the API is that the body text is
added via the XSimpleMailMessage2 subclass of  XSimpleMailMessage.</p>
<p>A typical call to sendEmailByClient():</p>
<div class="highlight"><pre><span></span><code><span class="c1">// part of LoMailer.java...</span>
<span class="n">Mail</span><span class="p">.</span><span class="na">sendEmailByClient</span><span class="p">(</span><span class="s">&quot;xxx@xxx&quot;</span><span class="p">,</span> <span class="s">&quot;Test&quot;</span><span class="p">,</span> <span class="s">&quot;Body&quot;</span><span class="p">,</span> <span class="s">&quot;skinner.png&quot;</span><span class="p">);</span>
</code></pre></div>
<p>The default e-mail client on Windows is the application associated with the mailto
protocol, as depicted in Figure 3.</p>
<p><img alt="" src="images/42-Sending_E-mail-3.png" /></p>
<p>Figure 3. The Default E-mail Client of Windows 7.</p>
<p>A good description of how to set up this association can be found at
<a href="http://www.ubergizmo.com/how-to/set-default-email-client-windows/">http://www.ubergizmo.com/how-to/set-default-email-client-windows/</a></p>
<h2 id="2-using-the-mailserviceprovider-service">2.  Using the MailServiceProvider Service<a class="headerlink" href="#2-using-the-mailserviceprovider-service" title="Permanent link">&para;</a></h2>
<p>The MailServiceProvider service utilizes a Python script called mailmerge.py which
creates a socket-based link to the specified mail server. If that link utilizes SSL (or its
successor TLS) for encrypted communication, then your code will probably crash
with the error message "No SSL support included in this Python".</p>
<p>This bug (<a href="https://bugs.documentfoundation.org/show_bug.cgi?id=77354">https://bugs.documentfoundation.org/show_bug.cgi?id=77354</a>) is marked
as "RESOLVED NOTOURBUG" at Office's bugzilla website which seems a bit
dismissive. The problem appears to be due to the position of Office's application
folders in Window's PATH environment variable. When Windows searches for two
DLLs, ssleay32.dll and libeay32.dll, which implement OpenSSL, it may find incorrect
versions in folders mentioned earlier in PATH. It's these incorrect DLLs that cause
Python to issue the cryptic error. One solution is to copy the correct DLLs from
Office's "program\" folder into the "program\python-core-???\lib\" folder (??? is a
version number, such as 3.3.3), thereby ensuring they're chosen first.</p>
<p>Another issue with switching to MailServiceProvider is that the programmer must
supply more information  to setup the SMTP connection, namely the address of the
mail server, its port, and the login and password for accessing the server.</p>
<p>MailServiceProvider is utilized by the Mail.sendEmail() function. Given below are
examples of how it sends e-mail to my local fivedots.coe.psu.ac.th mail server and to
the Gmail server at smtp.gmail.com:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// part of LoMailer.java...</span>
<span class="n">Mail</span><span class="p">.</span><span class="na">sendEmail</span><span class="p">(</span><span class="s">&quot;fivedots.coe.psu.ac.th&quot;</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="s">&quot;ad&quot;</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span>
      <span class="s">&quot;xxx@xxx&quot;</span><span class="p">,</span> <span class="s">&quot;Test 1&quot;</span><span class="p">,</span> <span class="s">&quot;Body 1&quot;</span><span class="p">,</span> <span class="s">&quot;skinner.png&quot;</span><span class="p">);</span>

<span class="n">Mail</span><span class="p">.</span><span class="na">sendEmail</span><span class="p">(</span><span class="s">&quot;smtp.gmail.com&quot;</span><span class="p">,</span> <span class="mi">587</span><span class="p">,</span>
               <span class="s">&quot;Andrew.Davison50@gmail.com&quot;</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span>
      <span class="s">&quot;xxx@xxx&quot;</span><span class="p">,</span><span class="s">&quot;Test 2&quot;</span><span class="p">,</span> <span class="s">&quot;Body 2&quot;</span><span class="p">,</span> <span class="s">&quot;addresses.ods&quot;</span><span class="p">);</span>
</code></pre></div>
<p>The Mail.sendEmail() arguments are: the mail server address, its port, the login and
password for the server, the recipient of the mail, the subject line, the body text, and
an optional attachment filename.</p>
<p>SMTP is built on top of a TCP network link, and in these security conscious days
many companies and universities (including mine) use firewalls to block everything
but Web links. That means I cannot use MailServiceProvider to access my Gmail
account at work since its mail server is beyond my departmental firewall. However, I
can access the fivedots departmental mail server.</p>
<p>MailServiceProvider is located in the mail module, along with several interfaces. The
other important service is MailMessage for constructing e-mail messages. Figure 4
shows the relationships between the services and their interfaces.</p>
<p><img alt="" src="images/42-Sending_E-mail-4.png" /></p>
<p>Figure 4. The MailServiceProvider and MailMessage Services.</p>
<p>An SMTP service is created via the XMailServiceProvider interface:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// part of Mail.sendEmail()</span>
       <span class="p">:</span>
<span class="n">XMailServiceProvider</span> <span class="n">msp</span> <span class="o">=</span>
          <span class="n">Lo</span><span class="p">.</span><span class="na">createInstanceMCF</span><span class="p">(</span><span class="n">XMailServiceProvider</span><span class="p">.</span><span class="na">class</span><span class="p">,</span>
                <span class="s">&quot;com.sun.star.mail.MailServiceProvider&quot;</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">msp</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Could not create MailServiceProvider&quot;</span><span class="p">);</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">XMailService</span> <span class="n">service</span> <span class="o">=</span> <span class="n">msp</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="n">MailServiceType</span><span class="p">.</span><span class="na">SMTP</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">service</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Could not create SMTP MailService&quot;</span><span class="p">);</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>A listener can be attached to the service, to report on its connection status:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// part of Mail.sendEmail()</span>
      <span class="p">:</span>
<span class="n">service</span><span class="p">.</span><span class="na">addConnectionListener</span><span class="p">(</span> <span class="k">new</span> <span class="n">XConnectionListener</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">connected</span><span class="p">(</span><span class="n">EventObject</span> <span class="n">e</span><span class="p">)</span>
  <span class="p">{</span>  <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Connected to server &quot;</span> <span class="o">+</span><span class="n">getServerName</span><span class="p">(</span><span class="n">e</span><span class="p">));</span> <span class="p">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">disconnected</span><span class="p">(</span><span class="n">EventObject</span> <span class="n">e</span><span class="p">)</span>
  <span class="p">{</span>  <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;  Disconnected&quot;</span><span class="p">);</span> <span class="p">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">disposing</span><span class="p">(</span><span class="n">EventObject</span> <span class="n">e</span><span class="p">)</span> <span class="p">{}</span>
<span class="p">});</span>
</code></pre></div>
<p>The connection requires address, port, protocol, login and password details, which are
supplied through XCurrentContext and XAuthenticator:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// in the Mail class</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">sendEmail</span><span class="p">(</span><span class="n">String</span> <span class="n">mailhost</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span>
                <span class="n">String</span> <span class="n">user</span><span class="p">,</span> <span class="n">String</span> <span class="n">password</span><span class="p">,</span>
                <span class="n">String</span> <span class="n">to</span><span class="p">,</span> <span class="n">String</span> <span class="n">subject</span><span class="p">,</span> <span class="n">String</span> <span class="n">body</span><span class="p">,</span> <span class="n">String</span> <span class="n">fnm</span><span class="p">)</span>
<span class="p">{</span>
  <span class="p">:</span>  <span class="c1">// service creation code; see above</span>

  <span class="c1">// initialize service data: context and authenticator</span>
  <span class="n">XCurrentContext</span> <span class="n">xcc</span> <span class="o">=</span> <span class="k">new</span> <span class="n">XCurrentContext</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">getValueByName</span><span class="p">(</span><span class="n">String</span> <span class="n">name</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="s">&quot;ServerName&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">Object</span><span class="p">)</span> <span class="n">mailhost</span><span class="p">;</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="s">&quot;Port&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">Object</span><span class="p">)</span> <span class="k">new</span> <span class="n">Integer</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="s">&quot;ConnectionType&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">Object</span><span class="p">)</span> <span class="s">&quot;Ssl&quot;</span><span class="p">;</span>     <span class="c1">// or &quot;Insecure&quot;;</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="s">&quot;Timeout&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">Object</span><span class="p">)</span>  <span class="k">new</span> <span class="n">Integer</span><span class="p">(</span><span class="mi">60</span><span class="p">);</span>
      <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Do not recognize \&quot;&quot;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">&quot;\&quot;&quot;</span><span class="p">);</span>
      <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="n">XAuthenticator</span> <span class="n">auth</span> <span class="o">=</span> <span class="k">new</span> <span class="n">XAuthenticator</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getUserName</span><span class="p">()</span>
    <span class="p">{</span> <span class="k">return</span> <span class="n">user</span><span class="p">;</span>  <span class="p">}</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getPassword</span><span class="p">()</span>
    <span class="p">{</span> <span class="k">return</span> <span class="n">password</span><span class="p">;</span>  <span class="p">}</span>
  <span class="p">};</span>

  <span class="c1">// connect to service</span>
  <span class="n">service</span><span class="p">.</span><span class="na">connect</span><span class="p">(</span><span class="n">xcc</span><span class="p">,</span> <span class="n">auth</span><span class="p">);</span>
  <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Isconnected: &quot;</span> <span class="o">+</span> <span class="n">service</span><span class="p">.</span><span class="na">isConnected</span><span class="p">());</span>
</code></pre></div>
<p>I've hardwired a time of 60 seconds in XCurrentContext which sets how long the code
waits for a connection before giving up.</p>
<p>MailMessage utilizes an unusual create() method, and the message's body is
represented by an XTransferable instance rather than a string:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// part of Mail.sendEmail()</span>
      <span class="p">:</span>
<span class="n">String</span> <span class="n">from</span> <span class="o">=</span> <span class="n">user</span> <span class="o">+</span> <span class="s">&quot;@&quot;</span> <span class="o">+</span> <span class="n">mailhost</span><span class="p">;</span>  <span class="c1">// person sending this e-mail</span>
<span class="n">XMailMessage</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">com</span><span class="p">.</span><span class="na">sun</span><span class="p">.</span><span class="na">star</span><span class="p">.</span><span class="na">mail</span><span class="p">.</span><span class="na">MailMessage</span><span class="p">.</span><span class="na">create</span><span class="p">(</span>
                 <span class="n">Lo</span><span class="p">.</span><span class="na">getContext</span><span class="p">(),</span> <span class="n">to</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span>
                 <span class="n">subject</span><span class="p">,</span> <span class="k">new</span> <span class="n">TextTransferable</span><span class="p">(</span><span class="n">body</span><span class="p">));</span>
</code></pre></div>
<p>The online documentation for MailMessage.create() (use <code>lodoc MailMessage</code> to
access it) is misleading in that it doesnt mention the need for the component context,
which is obtained with the Lo.getContext() call.</p>
<p>My TextTransferable class implements the XTransferable interface, which defines
how different MIME data types are transferred. XTransferable is mainly used in two
ways  for packaging e-mail data (as here), and for moving data to and from the
clipboard (which I'll discuss in the next chapter).</p>
<p>TextTransferable lets Unicode text be treated as a transferable:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// in the Utils/ folder</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TextTransferable</span> <span class="kd">implements</span> <span class="n">XTransferable</span>
<span class="p">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">text</span><span class="p">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">UNICODE_MIMETYPE</span> <span class="o">=</span><span class="s">&quot;text/plain;charset=utf-16&quot;</span><span class="p">;</span>

  <span class="kd">public</span> <span class="nf">TextTransferable</span><span class="p">(</span><span class="n">String</span> <span class="n">s</span><span class="p">)</span>
  <span class="p">{</span>  <span class="n">text</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>  <span class="p">}</span>

  <span class="kd">public</span> <span class="n">Object</span> <span class="nf">getTransferData</span><span class="p">(</span><span class="n">DataFlavor</span> <span class="n">df</span><span class="p">)</span>
                         <span class="kd">throws</span> <span class="n">UnsupportedFlavorException</span>
  <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">df</span><span class="p">.</span><span class="na">MimeType</span><span class="p">.</span><span class="na">equalsIgnoreCase</span><span class="p">(</span><span class="n">UNICODE_MIMETYPE</span><span class="p">))</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="n">UnsupportedFlavorException</span><span class="p">();</span>
    <span class="k">return</span> <span class="n">text</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">public</span> <span class="n">DataFlavor</span><span class="o">[]</span> <span class="nf">getTransferDataFlavors</span><span class="p">()</span>
  <span class="p">{</span> <span class="n">DataFlavor</span><span class="o">[]</span> <span class="n">dfs</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataFlavor</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="p">;</span>
    <span class="n">dfs</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataFlavor</span><span class="p">(</span><span class="n">UNICODE_MIMETYPE</span><span class="p">,</span> <span class="s">&quot;Unicode Text&quot;</span><span class="p">,</span>
                                      <span class="k">new</span> <span class="n">Type</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">));</span>
    <span class="k">return</span> <span class="n">dfs</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isDataFlavorSupported</span><span class="p">(</span><span class="n">DataFlavor</span> <span class="n">df</span><span class="p">)</span>
  <span class="p">{</span>  <span class="k">return</span> <span class="n">df</span><span class="p">.</span><span class="na">MimeType</span><span class="p">.</span><span class="na">equalsIgnoreCase</span><span class="p">(</span><span class="n">UNICODE_MIMETYPE</span><span class="p">);</span>  <span class="p">}</span>

<span class="p">}</span>  <span class="c1">// end of TextTransferable class</span>
</code></pre></div>
<p>A DataFlavor object hold three fields: the MIME type string for the data (e.g.
"text/plain"), a 'human presentable' name for the data (which can be anything), and the
corresponding Office data type.</p>
<p>We're not finished with transferable data since an attached file must also be packaged
in a similar way using Office's MailAttachment class and my FileTransferable class:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// part of Mail.sendEmail()</span>
<span class="k">if</span> <span class="p">(</span><span class="n">fnm</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span>
  <span class="n">msg</span><span class="p">.</span><span class="na">addAttachment</span><span class="p">(</span> <span class="k">new</span> <span class="n">MailAttachment</span><span class="p">(</span>
                             <span class="k">new</span> <span class="n">FileTransferable</span><span class="p">(</span><span class="n">fnm</span><span class="p">),</span> <span class="n">fnm</span><span class="p">));</span>
</code></pre></div>
<p>FileTransferable looks up the MIME type for its supplied file, and stores the file
contents in a byte array which is returned by getTransferData():</p>
<div class="highlight"><pre><span></span><code><span class="c1">// in the Utils/ folder</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">FileTransferable</span> <span class="kd">implements</span> <span class="n">XTransferable</span>
<span class="p">{</span>
  <span class="kd">private</span> <span class="n">String</span> <span class="n">mimeType</span> <span class="o">=</span> <span class="s">&quot;application/octet-stream&quot;</span><span class="p">;</span>   <span class="c1">// default</span>
  <span class="kd">private</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">fileData</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>


  <span class="kd">public</span> <span class="nf">FileTransferable</span><span class="p">(</span><span class="n">String</span> <span class="n">fnm</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">mimeType</span> <span class="o">=</span> <span class="n">Info</span><span class="p">.</span><span class="na">getMIMEType</span><span class="p">(</span><span class="n">fnm</span><span class="p">);</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="n">fileData</span> <span class="o">=</span> <span class="n">Files</span><span class="p">.</span><span class="na">readAllBytes</span><span class="p">(</span> <span class="n">Paths</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">fnm</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="n">java</span><span class="p">.</span><span class="na">lang</span><span class="p">.</span><span class="na">Exception</span> <span class="n">e</span><span class="p">)</span>
    <span class="p">{</span>  <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Could not read bytes from &quot;</span> <span class="o">+</span> <span class="n">fnm</span><span class="p">);</span>  <span class="p">}</span>
  <span class="p">}</span>  <span class="c1">// end of FileTransferable()</span>


  <span class="kd">public</span> <span class="n">Object</span> <span class="nf">getTransferData</span><span class="p">(</span><span class="n">DataFlavor</span> <span class="n">df</span><span class="p">)</span>
                               <span class="kd">throws</span> <span class="n">UnsupportedFlavorException</span>
  <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">df</span><span class="p">.</span><span class="na">MimeType</span><span class="p">.</span><span class="na">equalsIgnoreCase</span><span class="p">(</span><span class="n">mimeType</span><span class="p">))</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="n">UnsupportedFlavorException</span><span class="p">();</span>
    <span class="k">return</span> <span class="n">fileData</span><span class="p">;</span>
  <span class="p">}</span>  <span class="c1">// end of getTransferData()</span>


  <span class="kd">public</span> <span class="n">DataFlavor</span><span class="o">[]</span> <span class="nf">getTransferDataFlavors</span><span class="p">()</span>
  <span class="p">{</span> <span class="n">DataFlavor</span><span class="o">[]</span> <span class="n">flavors</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataFlavor</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="p">;</span>
    <span class="n">flavors</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataFlavor</span><span class="p">(</span><span class="n">mimeType</span><span class="p">,</span> <span class="n">mimeType</span><span class="p">,</span>
                                      <span class="k">new</span> <span class="n">Type</span><span class="p">(</span><span class="kt">byte</span><span class="o">[]</span><span class="p">.</span><span class="na">class</span><span class="p">));</span>
    <span class="k">return</span> <span class="n">flavors</span><span class="p">;</span>
  <span class="p">}</span>


  <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isDataFlavorSupported</span><span class="p">(</span><span class="n">DataFlavor</span> <span class="n">df</span><span class="p">)</span>
  <span class="p">{</span>  <span class="k">return</span> <span class="n">df</span><span class="p">.</span><span class="na">MimeType</span><span class="p">.</span><span class="na">equalsIgnoreCase</span><span class="p">(</span><span class="n">mimeType</span><span class="p">);</span>  <span class="p">}</span>

<span class="p">}</span>  <span class="c1">// end of FileTransferable class</span>
</code></pre></div>
<p>MIME type lookup is implemented by Info.getMIMEType() which uses Java's
MimetypesFileTypeMap to examine a file of MIME types stored in my Utils/ folder:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// in the Info class</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">MIME_FNM</span> <span class="o">=</span> <span class="s">&quot;mime.types&quot;</span><span class="p">;</span>


<span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">getMIMEType</span><span class="p">(</span><span class="n">String</span> <span class="n">fnm</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">File</span> <span class="n">f</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="p">(</span><span class="n">fnm</span><span class="p">);</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="n">MimetypesFileTypeMap</span> <span class="n">mftMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MimetypesFileTypeMap</span><span class="p">(</span>
                          <span class="n">FileIO</span><span class="p">.</span><span class="na">getUtilsFolder</span><span class="p">()</span> <span class="o">+</span> <span class="n">MIME_FNM</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">mftMap</span><span class="p">.</span><span class="na">getContentType</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">catch</span><span class="p">(</span><span class="n">java</span><span class="p">.</span><span class="na">lang</span><span class="p">.</span><span class="na">Exception</span> <span class="n">e</span><span class="p">)</span>
  <span class="p">{</span>  <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Could not find &quot;</span> <span class="o">+</span> <span class="n">MIME_FNM</span><span class="p">);</span>
     <span class="k">return</span> <span class="s">&quot;application/octet-stream&quot;</span><span class="p">;</span>   <span class="c1">// better than nothing</span>
  <span class="p">}</span>
<span class="p">}</span>  <span class="c1">// end of getMIMEType()</span>
</code></pre></div>
<p>Back in Mail.sendEmail(), all that's left to do is to send the message using
XSmtpService.sendMailMessage():</p>
<div class="highlight"><pre><span></span><code><span class="c1">// part of Mail.sendEmail()...</span>
<span class="n">XSmtpService</span> <span class="n">smtpService</span> <span class="o">=</span> <span class="n">Lo</span><span class="p">.</span><span class="na">qi</span><span class="p">(</span><span class="n">XSmtpService</span><span class="p">.</span><span class="na">class</span><span class="p">,</span> <span class="n">service</span><span class="p">);</span>
<span class="n">smtpService</span><span class="p">.</span><span class="na">sendMailMessage</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>

<span class="n">service</span><span class="p">.</span><span class="na">disconnect</span><span class="p">();</span>
</code></pre></div>
<h2 id="3-using-javamail">3.  Using JavaMail<a class="headerlink" href="#3-using-javamail" title="Permanent link">&para;</a></h2>
<p>JavaMail can send and receive e-mail via SMTP, POP3 and IMAP (its website is
<a href="https://java.net/projects/javamail/pages/Home">https://java.net/projects/javamail/pages/Home</a>). Although JavaMail is mainly intended
to be a component of Java EE, it can be downloaded as a single JAR file
(javax.mail.jar) as an add-on to the JDK. It's being actively developed (the current
version is 1.5.6, released in mid 2016), and the website has lots of examples (see
<a href="http://java.net/projects/javamail/downloads/download/javamail-samples.zip">http://java.net/projects/javamail/downloads/download/javamail-samples.zip</a>), a FAQ,
and API documentation (at <a href="https://javamail.java.net/nonav/docs/api/">https://javamail.java.net/nonav/docs/api/</a>).</p>
<p>The main textbook about JavaMail is:</p>
<ul>
<li>JavaMail API 1<sup>st</sup> Edition
Elliotte Rusty Harold
O'Reilly, 2013</li>
</ul>
<p>This started out as a chapter in Harold's "Java Network Programming" text, but was
separated off after the 3<sup>rd</sup> edition.</p>
<p>Another nice resource if you want to build a GUI e-mail client using JavaMail is
chapter 5 of The Art of Java by Herbert Schlidt and James Holmes, McGraw Hill,
2003.</p>
<p>JavaMail utilizes the same approach as mailmerge.py mentioned earlier  it creates an
SMTP connection using a TCP socket link to a mail server. As such it suffers from
the same problem with firewalls, which means that I can't use it with my Gmail
account when I'm at work.</p>
<p>My non-Office e-mail support functions are in JMail.java, and have a similar interface
to the Office versions. For instance, JMail.sendEmail() is employed to send an e-mail
with JavaMail. The following two calls use the fivedots and Gmail servers:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// in JMailer.java...</span>
<span class="n">JMail</span><span class="p">.</span><span class="na">sendEmail</span><span class="p">(</span><span class="s">&quot;fivedots.coe.psu.ac.th&quot;</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="s">&quot;ad&quot;</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span>
      <span class="s">&quot;xxx@xxx&quot;</span><span class="p">,</span> <span class="s">&quot;Test 1&quot;</span><span class="p">,</span> <span class="s">&quot;Body 1&quot;</span><span class="p">,</span> <span class="s">&quot;skinner.png&quot;</span><span class="p">);</span>

<span class="n">JMail</span><span class="p">.</span><span class="na">sendEmail</span><span class="p">(</span><span class="s">&quot;smtp.gmail.com&quot;</span><span class="p">,</span> <span class="mi">587</span><span class="p">,</span>
               <span class="s">&quot;Andrew.Davison50@gmail.com&quot;</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span>
      <span class="s">&quot;xxx@xxx&quot;</span><span class="p">,</span><span class="s">&quot;Test 2&quot;</span><span class="p">,</span> <span class="s">&quot;Body 2&quot;</span><span class="p">,</span> <span class="s">&quot;addresses.ods&quot;</span><span class="p">);</span>
</code></pre></div>
<p>They're no different from my earlier Mail.sendEmail() examples, except for the name
of the support class. The arguments are: the mail server address, its port, the login and
password for the server, the recipient of the mail, the subject line, the body text, and
an optional attachment.</p>
<p>JavaMail sending is based around three classes: Transport, Session, and Message.</p>
<p>Transport specifies the underlying communication link, while Session handles the
details of the communication protocol using that link. For example, secure
communication is setup through properties passed to Session.getInstance():</p>
<div class="highlight"><pre><span></span><code><span class="c1">// part of JMail.sendEmail()...</span>
<span class="n">Properties</span> <span class="n">props</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Properties</span><span class="p">();</span>
<span class="n">props</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;mail.smtp.starttls.enable&quot;</span><span class="p">,</span> <span class="s">&quot;true&quot;</span><span class="p">);</span>
<span class="n">props</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;mail.smtp.ssl.trust&quot;</span><span class="p">,</span> <span class="s">&quot;*&quot;</span><span class="p">);</span>  <span class="c1">// no certificate needed</span>
<span class="n">props</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;mail.smtp.timeout&quot;</span><span class="p">,</span> <span class="s">&quot;60000&quot;</span><span class="p">);</span>

<span class="n">Session</span> <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="n">props</span><span class="p">);</span>
</code></pre></div>
<p>The mail server address, port, login and password details are used to create a
SMTPTransport instance (a subclass of Transport):</p>
<div class="highlight"><pre><span></span><code><span class="c1">// part of JMail.sendEmail()...</span>
<span class="n">URLName</span> <span class="n">url</span> <span class="o">=</span> <span class="k">new</span> <span class="n">URLName</span><span class="p">(</span><span class="s">&quot;smtp&quot;</span><span class="p">,</span> <span class="n">mailhost</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
                                              <span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="p">);</span>
<span class="n">Transport</span> <span class="n">transport</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SMTPTransport</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">url</span><span class="p">);</span>
<span class="n">transport</span><span class="p">.</span><span class="na">connect</span><span class="p">(</span><span class="n">mailhost</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="p">);</span>
</code></pre></div>
<p>JavaMail supports two kinds of listeners, one for the connection and the other for
message delivery. Simple implementations are given in JMail.sendEmail():</p>
<div class="highlight"><pre><span></span><code><span class="c1">// part of JMail.sendEmail()...</span>
      <span class="p">:</span>
<span class="n">transport</span><span class="p">.</span><span class="na">addConnectionListener</span><span class="p">(</span> <span class="k">new</span> <span class="n">ConnectionListener</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">opened</span><span class="p">(</span><span class="n">ConnectionEvent</span> <span class="n">e</span><span class="p">)</span>
  <span class="p">{</span>  <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;  Connection opened to: &quot;</span><span class="o">+</span><span class="n">e</span><span class="p">.</span><span class="na">getSource</span><span class="p">());</span> <span class="p">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">disconnected</span><span class="p">(</span><span class="n">ConnectionEvent</span> <span class="n">e</span><span class="p">)</span>
  <span class="p">{</span>  <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;  Connection disconnected&quot;</span><span class="p">);</span> <span class="p">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">closed</span><span class="p">(</span><span class="n">ConnectionEvent</span> <span class="n">e</span><span class="p">)</span>
  <span class="p">{</span>  <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;  Connection closed&quot;</span><span class="p">);</span> <span class="p">}</span>
<span class="p">});</span>

<span class="n">transport</span><span class="p">.</span><span class="na">addTransportListener</span><span class="p">(</span> <span class="k">new</span> <span class="n">TransportListener</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">messageDelivered</span><span class="p">(</span><span class="n">TransportEvent</span> <span class="n">e</span><span class="p">)</span>
  <span class="p">{</span>  <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;  Message delivered&quot;</span><span class="p">);</span>  <span class="p">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">messageNotDelivered</span><span class="p">(</span><span class="n">TransportEvent</span> <span class="n">e</span><span class="p">)</span>
  <span class="p">{</span>  <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;  Message not delivered&quot;</span><span class="p">);</span>  <span class="p">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">messagePartiallyDelivered</span><span class="p">(</span><span class="n">TransportEvent</span> <span class="n">e</span><span class="p">)</span>
  <span class="p">{</span>  <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;  Message partially delivered&quot;</span><span class="p">);</span>  <span class="p">}</span>
<span class="p">});</span>
</code></pre></div>
<p>An SMTP message has fields for the recipient, subject line, body text, and an optional
attached file:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// part of JMail.sendEmail()</span>
      <span class="p">:</span>
<span class="n">SMTPMessage</span> <span class="n">msg</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SMTPMessage</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>
<span class="n">msg</span><span class="p">.</span><span class="na">setReturnOption</span><span class="p">(</span><span class="n">SMTPMessage</span><span class="p">.</span><span class="na">RETURN_HDRS</span><span class="p">);</span>
<span class="n">msg</span><span class="p">.</span><span class="na">setNotifyOptions</span><span class="p">(</span><span class="n">SMTPMessage</span><span class="p">.</span><span class="na">NOTIFY_SUCCESS</span> <span class="o">|</span>
                     <span class="n">SMTPMessage</span><span class="p">.</span><span class="na">NOTIFY_FAILURE</span><span class="p">);</span>

<span class="n">msg</span><span class="p">.</span><span class="na">setFrom</span><span class="p">();</span>  <span class="c1">// uses default</span>
<span class="n">msg</span><span class="p">.</span><span class="na">setRecipient</span><span class="p">(</span><span class="n">Message</span><span class="p">.</span><span class="na">RecipientType</span><span class="p">.</span><span class="na">TO</span><span class="p">,</span> <span class="k">new</span> <span class="n">InternetAddress</span><span class="p">(</span><span class="n">to</span><span class="p">));</span>
<span class="n">msg</span><span class="p">.</span><span class="na">setSentDate</span><span class="p">(</span><span class="k">new</span> <span class="n">Date</span><span class="p">());</span>
<span class="n">msg</span><span class="p">.</span><span class="na">setSubject</span><span class="p">(</span><span class="n">subject</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="n">attachFnm</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span>
  <span class="n">msg</span><span class="p">.</span><span class="na">setText</span><span class="p">(</span><span class="n">body</span><span class="p">);</span>
<span class="k">else</span> <span class="p">{</span>   <span class="c1">// add body text and file as attachments</span>
  <span class="n">MimeBodyPart</span> <span class="n">p1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MimeBodyPart</span><span class="p">();</span>
  <span class="n">p1</span><span class="p">.</span><span class="na">setText</span><span class="p">(</span><span class="n">body</span><span class="p">);</span>

  <span class="n">String</span> <span class="n">mimeType</span> <span class="o">=</span> <span class="n">Info</span><span class="p">.</span><span class="na">getMIMEType</span><span class="p">(</span><span class="n">attachFnm</span><span class="p">);</span>

  <span class="n">MimeBodyPart</span> <span class="n">p2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MimeBodyPart</span><span class="p">();</span>
  <span class="n">FileDataSource</span> <span class="n">fds</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileDataSource</span><span class="p">(</span><span class="n">attachFnm</span><span class="p">);</span>
  <span class="n">p2</span><span class="p">.</span><span class="na">setDataHandler</span><span class="p">(</span><span class="k">new</span> <span class="n">DataHandler</span><span class="p">(</span><span class="n">fds</span><span class="p">));</span>  <span class="c1">// add data,</span>
  <span class="n">p2</span><span class="p">.</span><span class="na">setFileName</span><span class="p">(</span><span class="n">fds</span><span class="p">.</span><span class="na">getName</span><span class="p">());</span>            <span class="c1">// filename,</span>
  <span class="n">p2</span><span class="p">.</span><span class="na">setHeader</span><span class="p">(</span><span class="s">&quot;Content-Type&quot;</span><span class="p">,</span> <span class="n">mimeType</span><span class="p">);</span>   <span class="c1">// MIME type</span>

  <span class="c1">// create multipart</span>
  <span class="n">Multipart</span> <span class="n">mp</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MimeMultipart</span><span class="p">();</span>
  <span class="n">mp</span><span class="p">.</span><span class="na">addBodyPart</span><span class="p">(</span><span class="n">p1</span><span class="p">);</span>   <span class="c1">// for body text</span>
  <span class="n">mp</span><span class="p">.</span><span class="na">addBodyPart</span><span class="p">(</span><span class="n">p2</span><span class="p">);</span>   <span class="c1">// for the attached file</span>
  <span class="n">msg</span><span class="p">.</span><span class="na">setContent</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>If the message contains body text and an attachment then it's necessary to add them as
MimeBodyPart objects in a Multipart container. Body text on its own can be added
using SMTPMessage.setText().</p>
<p>The MimeBodyPart holding the attachment must include the file's MIME type in its
"Content-type" header.</p>
<p>Once the message has been sent, the link is closed:</p>
<div class="highlight"><pre><span></span><code><span class="n">transport</span><span class="p">.</span><span class="na">sendMessage</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="na">getAllRecipients</span><span class="p">());</span>
<span class="n">transport</span><span class="p">.</span><span class="na">close</span><span class="p">();</span>
</code></pre></div>
<h2 id="4-the-desktop-api">4.  The Desktop API<a class="headerlink" href="#4-the-desktop-api" title="Permanent link">&para;</a></h2>
<p>The Java equivalent of Office's SimpleSystemMail/SimpleCommandMail service is
the Desktop.mail() method. It utilizes the OSes default e-mail client to post a
message, which means that there's no need to download the javax.mail JAR. The
delivery doesn't need to explicitly include the mail server address, port, login, and
password since they're obtained from the client's settings.</p>
<p>Desktop.mail() utilizes the mailto protocol to communicate with the client, but its
specification (in RFC 2368, at <a href="http://www.ietf.org/rfc/rfc2368.txt">http://www.ietf.org/rfc/rfc2368.txt</a>) doesn't cover
attachments. There are unofficial extensions supported by some clients, but they're not
part of Thunderbird (but see the next section).</p>
<p>The mailto syntax is:</p>
<div class="highlight"><pre><span></span><code>&quot;mailto:&quot; recipients [ &quot;?&quot; key &quot;=&quot; value  (&quot;&amp;&quot; key &quot;=&quot; value)* ]
</code></pre></div>
<p>with</p>
<ul>
<li><code>recipients:</code> comma-separated e-mail addresses without spaces; Outlook needs
semicolons instead of commas;</li>
<li><code>key: subject, cc, bcc, body</code> (note: there's no attachment keyword);</li>
<li><code>value:</code> URL-encoded text (e.g. space becomes %20).</li>
</ul>
<p>An example:</p>
<div class="highlight"><pre><span></span><code>mailto:xxx@xxx?subject=Hello&amp;body=How%20are%20you%3F
</code></pre></div>
<p>Desktop.mail() is employed by JMail.sendEmailByClient(). An example of its use:</p>
<div class="highlight"><pre><span></span><code>JMail.sendEmailByClient(&quot;xxx@xxx&quot;, &quot;Hello&quot;, &quot;How are you?&quot;);
</code></pre></div>
<p>There's no way in Desktop to suppress the client's GUI, which appears on-screen, and
the user must press the "Send" button (or equivalent) to post out the message.</p>
<p>JMail.sendEmailByClient() is:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// in the JMail class</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">sendEmailByClient</span><span class="p">(</span><span class="n">String</span> <span class="n">to</span><span class="p">,</span>
                                    <span class="n">String</span> <span class="n">subject</span><span class="p">,</span> <span class="n">String</span> <span class="n">body</span><span class="p">)</span>
<span class="p">{</span>  <span class="n">sendEmailByClient</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>  <span class="p">}</span>



<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">sendEmailByClient</span><span class="p">(</span><span class="n">String</span> <span class="n">to</span><span class="p">,</span> <span class="n">String</span> <span class="n">subject</span><span class="p">,</span>
                                     <span class="n">String</span> <span class="n">body</span><span class="p">,</span> <span class="n">String</span> <span class="n">fnm</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Desktop</span><span class="p">.</span><span class="na">isDesktopSupported</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Desktop mail not supported&quot;</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// construct &quot;mailto:&quot; string for Desktop.mail()</span>
  <span class="n">String</span> <span class="n">uriStr</span> <span class="o">=</span> <span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">&quot;mailto:%s?subject=%s&amp;body=%s&quot;</span><span class="p">,</span>
                            <span class="n">encodeMailto</span><span class="p">(</span><span class="n">to</span><span class="p">),</span> <span class="n">encodeMailto</span><span class="p">(</span><span class="n">subject</span><span class="p">),</span>
                            <span class="n">encodeMailto</span><span class="p">(</span><span class="n">body</span><span class="p">)</span> <span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">fnm</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span>
    <span class="n">uriStr</span> <span class="o">+=</span> <span class="s">&quot;&amp;attachment=\&quot;&quot;</span> <span class="o">+</span> <span class="n">FileIO</span><span class="p">.</span><span class="na">getAbsolutePath</span><span class="p">(</span><span class="n">fnm</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;\&quot;&quot;</span><span class="p">;</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="n">Desktop</span> <span class="n">desktop</span> <span class="o">=</span> <span class="n">Desktop</span><span class="p">.</span><span class="na">getDesktop</span><span class="p">();</span>
    <span class="n">desktop</span><span class="p">.</span><span class="na">mail</span><span class="p">(</span><span class="k">new</span> <span class="n">URI</span><span class="p">(</span><span class="n">uriStr</span><span class="p">));</span>
  <span class="p">}</span>
  <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span>
  <span class="p">{</span>  <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">e</span><span class="p">);</span> <span class="p">}</span>
<span class="p">}</span>  <span class="c1">// end of sendEmailByClient()</span>


<span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">encodeMailto</span><span class="p">(</span><span class="n">String</span> <span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">URLEncoder</span><span class="p">.</span><span class="na">encode</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;UTF-8&quot;</span><span class="p">).</span><span class="na">replace</span><span class="p">(</span><span class="s">&quot;+&quot;</span><span class="p">,</span> <span class="s">&quot;%20&quot;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">catch</span> <span class="p">(</span><span class="n">UnsupportedEncodingException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
     <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Could not encode: \&quot;&quot;</span> <span class="o">+</span> <span class="n">str</span> <span class="o">+</span> <span class="s">&quot;\&quot;&quot;</span><span class="p">);</span>
     <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>  <span class="c1">// end of encodeMailto()</span>
</code></pre></div>
<p>Following the mailto specification, the key values in the mailto string must be URL
encoded.</p>
<p>sendEmailByClient() has an attachment argument mainly because I've read that some
clients, such as Outlook, can accept it. But if I try to use an attachment with
Thunderbird, the call to Desktop.mail() fails.</p>
<h2 id="5-thunderbird-scripting">5.  Thunderbird Scripting<a class="headerlink" href="#5-thunderbird-scripting" title="Permanent link">&para;</a></h2>
<p>The reason for my uncertainty about Thunderbird supporting attachments is that
although it doesn't allow them in "mailto" strings, it can process attachments via its
GUI, and the command line (see
<a href="http://kb.mozillazine.org/Command_line_arguments_-_Thunderbird">http://kb.mozillazine.org/Command_line_arguments_-_Thunderbird</a>). Its command
line features open up another way of sending e-mail: by having Java execute
Thunderbird through an external script.</p>
<p>My Windows batch file, called TBExec.bat, applies various checks to its command
line arguments, and then invokes Thunderbird using:</p>
<div class="highlight"><pre><span></span><code><span class="n">thunderbird</span><span class="p">.</span><span class="na">exe</span> <span class="o">-</span><span class="n">compose</span> <span class="s">&quot;to=&#39;%1&#39;,subject=&#39;%2&#39;,</span>
<span class="s">                          body=&#39;%3&#39;,attachment=&#39;%CD%\%4&#39;&quot;</span>
</code></pre></div>
<p>The "attachment" value is an absolute file name.</p>
<p>The Java code uses Runtime.exec() to execute the batch file, passing it three or four
arguments:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// in the JMail class</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">sendEmailByTB</span><span class="p">(</span><span class="n">String</span> <span class="n">to</span><span class="p">,</span> <span class="n">String</span> <span class="n">subject</span><span class="p">,</span>
                                 <span class="n">String</span> <span class="n">body</span><span class="p">,</span> <span class="n">String</span> <span class="n">fnm</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">String</span> <span class="n">mailExec</span> <span class="o">=</span>
      <span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">&quot;cmd /c TBExec.bat %s \&quot;%s\&quot; \&quot;%s\&quot;&quot;</span><span class="p">,</span>
                                       <span class="n">to</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">body</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">fnm</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span>  <span class="c1">// add attachment argument</span>
    <span class="n">mailExec</span> <span class="o">+=</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="n">fnm</span><span class="p">;</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="n">Process</span> <span class="n">p</span> <span class="o">=</span> <span class="n">Runtime</span><span class="p">.</span><span class="na">getRuntime</span><span class="p">().</span><span class="na">exec</span><span class="p">(</span><span class="n">mailExec</span><span class="p">);</span>
    <span class="n">p</span><span class="p">.</span><span class="na">waitFor</span><span class="p">();</span>
    <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Sent e-mail using Thunderbird&quot;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">catch</span> <span class="p">(</span><span class="n">java</span><span class="p">.</span><span class="na">lang</span><span class="p">.</span><span class="na">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Unable to send Thunderbird mail: &quot;</span> <span class="o">+</span> <span class="n">e</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>  <span class="c1">// end of sendEmailByTB()</span>
</code></pre></div>
<p>As with Desktop.mail(), there's no way to stop the Thunderbird GUI from being
displayed, and the user has to press the "Send" button to send off the message.</p>
<h2 id="6-office-mail-merge">6.  Office Mail Merge<a class="headerlink" href="#6-office-mail-merge" title="Permanent link">&para;</a></h2>
<p>Mail merge usually involves a spreadsheet of data and a form letter stored as a Writer
template (an OTT file). Data from the spreadsheet replaces fields in the template, such
as &lt; Name &gt; and &lt; Address &gt;, with real names and addresses, creating a series of
personalized letters. Other common uses are to generate labels and envelopes.</p>
<p>After the letters (or labels or envelopes) have been created, they can be saved to files
(or to a single file), sent to a printer, or attached to e-mails. It's because of this last
choice that I've included mail merging here.</p>
<p>Figure 5 pictures the mail merge stages in more detail.</p>
<p><img alt="" src="images/42-Sending_E-mail-5.png" /></p>
<p>Figure 5. Mail Merging using a Spreadsheet and a Writer Template.</p>
<h3 id="61-preparing-the-mail-merge-inputs">6.1.  Preparing the Mail Merge Inputs<a class="headerlink" href="#61-preparing-the-mail-merge-inputs" title="Permanent link">&para;</a></h3>
<p>Mail merge configuration is most easily done using Office's GUI and wizards, and is
excellently explained in chapter 11 of the Writer Guide (available from
<a href="https://th.libreoffice.org/get-help/documentation/">https://th.libreoffice.org/get-help/documentation/</a>).</p>
<p>A screenshot of a typical spreadsheet is shown in Figure 6.</p>
<p><img alt="" src="images/42-Sending_E-mail-6.png" /></p>
<p>Figure 6. The addresses.ods Spreadsheet.</p>
<p>The field names employed in the template correspond to column names in the
spreadsheet (e.g. "Title" and "First Name"). Also, if the merging involves posting out
of e-mails then there must be an "E-mail" column in the sheet; those addresses will be
used as the message recipients.</p>
<p>The spreadsheet has to be converted into a data source for the merge. This is done via
Office's  File, Wizards, Address Data Source menu item, as explained in the Writer
Guide. The outcome is a new ODB file with the same name as the spreadsheet
(addresses.odb in my case). This data source can be viewed from inside Calc by
selecting the menu item View, Data Sources. The GUI display is shown in Figure 7.</p>
<p><img alt="" src="images/42-Sending_E-mail-7.png" /></p>
<p>Figure 7. Addresses.ods with a Data Source.</p>
<p>The "Addresses" data source has been opened to show its "Addresses" table. Both of
these names will be needed later when we start programming.</p>
<p>The next step is to add fields in the "Addresses" table to the Writer template. This
involves dragging field names from the top row of the  table over to the template, and
positioning them in the text. Figure 8 shows part of the resulting template, stored in
formLetter.ott.</p>
<p><img alt="" src="images/42-Sending_E-mail-8.png" /></p>
<p>Figure 8. Part of formLetter.ott.</p>
<p>The fields are automatically displayed in angled brackets inside gray rectangles.</p>
<h3 id="62-programming-the-mail-merge">6.2.  Programming the Mail Merge<a class="headerlink" href="#62-programming-the-mail-merge" title="Permanent link">&para;</a></h3>
<p>The MailMerge service is located in the text module; most of its programming
involves setting properties, and then calling XJob.execute(). The main services and
interfaces are shown in Figure 9.</p>
<p><img alt="" src="images/42-Sending_E-mail-9.png" /></p>
<p>Figure 9. The MailMerge Service and Interfaces.</p>
<p>The XMailMergeBroadcaster interface is employed to attach a listener to the merging
process, and XCancellable can kill the merge.</p>
<p>If you look at the documentation for the MailMerge and DataAccessDescriptor
services (e.g. use <code>lodoc MailMerge</code>), you'll discover many properties in both, and
that most (but not all) of the DataAccessDescriptor properties are redefined in
MailMerge.</p>
<p>The coding is summarized by the following snippet from Mail.mergeTask():</p>
<div class="highlight"><pre><span></span><code><span class="c1">// in Mail.mergeTask()</span>
  <span class="p">:</span>
<span class="n">XJob</span> <span class="n">job</span> <span class="o">=</span> <span class="n">Lo</span><span class="p">.</span><span class="na">createInstanceMCF</span><span class="p">(</span><span class="n">XJob</span><span class="p">.</span><span class="na">class</span><span class="p">,</span>
                             <span class="s">&quot;com.sun.star.text.MailMerge&quot;</span><span class="p">);</span>

<span class="n">XPropertySet</span> <span class="n">props</span> <span class="o">=</span> <span class="n">Lo</span><span class="p">.</span><span class="na">qi</span><span class="p">(</span><span class="n">XPropertySet</span><span class="p">.</span><span class="na">class</span><span class="p">,</span> <span class="n">job</span><span class="p">);</span>
<span class="n">Props</span><span class="p">.</span><span class="na">setProperty</span><span class="p">(</span><span class="n">props</span><span class="p">,</span> <span class="s">&quot;DataSourceName&quot;</span><span class="p">,</span> <span class="n">dataSourceName</span><span class="p">);</span>
<span class="n">Props</span><span class="p">.</span><span class="na">setProperty</span><span class="p">(</span><span class="n">props</span><span class="p">,</span> <span class="s">&quot;Command&quot;</span><span class="p">,</span> <span class="n">tableName</span><span class="p">);</span>
  <span class="p">:</span>   <span class="c1">// many more properties are set...</span>
  <span class="p">:</span>

<span class="n">job</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="k">new</span> <span class="n">NamedValue</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">);</span>
</code></pre></div>
<p>The MailMerge service is created as an XJob interface. Service properties are set, and
then the merge is carried out by calling XJob.execute(). The NamedValue array is
empty since there's no need to set any more properties using it.</p>
<h3 id="63-specializing-the-merge">6.3.  Specializing the Merge<a class="headerlink" href="#63-specializing-the-merge" title="Permanent link">&para;</a></h3>
<p>Mail.mergeTask() is passed numerous property values. To simplify its interface, the
call is hidden inside three other functions called Mail.mergeLetter(),
Mail.mergePrint(), and Mail.mergeEmail(), which focus on the three different
outcomes of a merge (see Figure 5).</p>
<p>Mail.mergeLetter() takes four arguments, three of which (data source name, table
name, template filename) are needed for any kind of merge:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// in  the Mail class</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">mergeLetter</span><span class="p">(</span><span class="n">String</span> <span class="n">dataSourceName</span><span class="p">,</span>
                               <span class="n">String</span> <span class="n">tableName</span><span class="p">,</span> <span class="n">String</span> <span class="n">templateFnm</span><span class="p">,</span>
                               <span class="kt">boolean</span> <span class="n">isSingle</span><span class="p">)</span>
<span class="p">{</span> <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Merging letters to files...&quot;</span><span class="p">);</span>
  <span class="n">mergeTask</span><span class="p">(</span><span class="n">dataSourceName</span><span class="p">,</span> <span class="n">tableName</span><span class="p">,</span> <span class="n">templateFnm</span><span class="p">,</span>
          <span class="n">MailMergeType</span><span class="p">.</span><span class="na">FILE</span><span class="p">,</span>
          <span class="n">isSingle</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
  <span class="p">}</span>  <span class="c1">// end of mergeLetter()</span>
</code></pre></div>
<p>The following call to Mail.mergeLetter() saves six letters as "letter0.odt" to
"letter5.odt":</p>
<div class="highlight"><pre><span></span><code><span class="c1">// in MailMerge.java...</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">DATA_SOURCE_NAME</span> <span class="o">=</span> <span class="s">&quot;Addresses&quot;</span><span class="p">;</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">TABLE_NAME</span> <span class="o">=</span> <span class="s">&quot;Addresses&quot;</span><span class="p">;</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">TEMPLATE_FNM</span> <span class="o">=</span> <span class="s">&quot;formLetter.ott&quot;</span><span class="p">;</span>


<span class="n">Mail</span><span class="p">.</span><span class="na">mergeLetter</span><span class="p">(</span><span class="n">DATA_SOURCE_NAME</span><span class="p">,</span> <span class="n">TABLE_NAME</span><span class="p">,</span> <span class="n">TEMPLATE_FNM</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
</code></pre></div>
<p>I've defined the data source name, table name, and template filename as constants to
make the call to Mail.mergeLetter() easier to read. The boolean argument specifies
whether a single file should hold all the generated letters. The generated filenames are
hardwired inside Mail.mergeTask() to be "letter" and a number.</p>
<p>Six files are created since the spreadsheet (see Figure 6) has six rows of data.</p>
<p>Mail.mergePrint() is passed the same first three arguments (data source name, table
name, template filename), and a printer name and a boolean to signal whether
multiple print jobs should be created:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// in MailMerge.java...</span>
<span class="n">Mail</span><span class="p">.</span><span class="na">mergePrint</span><span class="p">(</span><span class="n">DATA_SOURCE_NAME</span><span class="p">,</span> <span class="n">TABLE_NAME</span><span class="p">,</span> <span class="n">TEMPLATE_FNM</span><span class="p">,</span>
                <span class="s">&quot;FinePrint&quot;</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
</code></pre></div>
<p>This example will send a single combined print job to the "FinePrint" printer. The
printer name can be obtained using one of the techniques explained in the previous
chapter.</p>
<p>Mail.mergePrint() calls Mail.mergeTask() with its printer name and multiple jobs
boolean arguments set:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// in the Mail class</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">mergePrint</span><span class="p">(</span><span class="n">String</span> <span class="n">dataSourceName</span><span class="p">,</span>
                              <span class="n">String</span> <span class="n">tableName</span><span class="p">,</span> <span class="n">String</span> <span class="n">templateFnm</span><span class="p">,</span>
                       <span class="n">String</span> <span class="n">printerName</span><span class="p">,</span> <span class="kt">boolean</span> <span class="n">isMultipleJobs</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Merging letters for printing...&quot;</span><span class="p">);</span>
  <span class="n">mergeTask</span><span class="p">(</span><span class="n">dataSourceName</span><span class="p">,</span> <span class="n">tableName</span><span class="p">,</span> <span class="n">templateFnm</span><span class="p">,</span>
            <span class="n">MailMergeType</span><span class="p">.</span><span class="na">PRINTER</span><span class="p">,</span>
           <span class="kc">false</span><span class="p">,</span> <span class="n">printerName</span><span class="p">,</span> <span class="n">isMultipleJobs</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
<span class="p">}</span>  <span class="c1">// end of mergePrint()</span>
</code></pre></div>
<p>Mail.mergeEmail() is passed the data source name, table name, and template filename
as before, and the mail server's password, e-mail subject line and body string:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// in MailMerge.java...</span>
<span class="n">Mail</span><span class="p">.</span><span class="na">mergeEmail</span><span class="p">(</span><span class="n">DATA_SOURCE_NAME</span><span class="p">,</span> <span class="n">TABLE_NAME</span><span class="p">,</span> <span class="n">TEMPLATE_FNM</span><span class="p">,</span>
                <span class="n">password</span><span class="p">,</span>
                <span class="s">&quot;Hello&quot;</span><span class="p">,</span> <span class="s">&quot;Please read the attached message.&quot;</span><span class="p">);</span>
</code></pre></div>
<p>Six e-mails are sent to the addresses listed in the "E-mail" column of the spreadsheet
(see Figure 6). Each e-mail contains the subject and body text supplied in the call, and
an attached copy of the personalized letter.</p>
<p>Mail.mergeEmail() calls Mail.mergeTask():</p>
<div class="highlight"><pre><span></span><code><span class="c1">// in the Mail class</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">mergeEmail</span><span class="p">(</span><span class="n">String</span> <span class="n">dataSourceName</span><span class="p">,</span>
                              <span class="n">String</span> <span class="n">tableName</span><span class="p">,</span> <span class="n">String</span> <span class="n">templateFnm</span><span class="p">,</span>
                        <span class="n">String</span> <span class="n">passwd</span><span class="p">,</span> <span class="n">String</span> <span class="n">subject</span><span class="p">,</span> <span class="n">String</span> <span class="n">body</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Merging letters for sending as e-mail...&quot;</span><span class="p">);</span>
  <span class="kt">boolean</span> <span class="n">isConfigured</span> <span class="o">=</span> <span class="n">checkMailConfig</span><span class="p">(</span><span class="n">passwd</span><span class="p">);</span>
  <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;--&gt; Mailhost is &quot;</span> <span class="o">+</span>
              <span class="p">(</span><span class="n">isConfigured</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="p">:</span> <span class="s">&quot;NOT &quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;configured&quot;</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">isConfigured</span><span class="p">)</span>
    <span class="n">mergeTask</span><span class="p">(</span><span class="n">dataSourceName</span><span class="p">,</span> <span class="n">tableName</span><span class="p">,</span> <span class="n">templateFnm</span><span class="p">,</span>
              <span class="n">MailMergeType</span><span class="p">.</span><span class="na">MAIL</span><span class="p">,</span>
              <span class="kc">false</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="n">passwd</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">body</span><span class="p">);</span>
<span class="p">}</span>  <span class="c1">// end of mergeEmail()</span>
</code></pre></div>
<p>The e-mailing employs the same mailmerge.py Python script as MailServiceProvider,
which means it will crash when using SSL encryption unless ssleay32.dll and
libeay32.dll have been copied from Office's "program\" folder into "program\python-
core-???\lib\". Please refer back to section 2 for more details.</p>
<p>mailmerge.py attempts to open a link with the specified mail server at the given port,
and usually has to supply a login and password to be allowed access. If you look back
at the arguments passed to Mail.mergeEmail() you can see that the password is
supplied, but what about the mail server address, its port, and a login name?  The only
way to specify them is via Writer's option dialog. The relevant windows are shown in
Figure 10.</p>
<p><img alt="" src="images/42-Sending_E-mail-10.png" /></p>
<p>Figure 10. Setting Writer E-mail Options.</p>
<p>The left-hand dialog allows the mail server's address and port to be entered
(fivedots.coe.psu.ac.th and 25). If secure communication is required (i.e. SSL, TLS, or
STARTTLS), then the secure SSL checkbox is ticked and the "Server Authentication"
button pressed. A second dialog opens, shown on the right in Figure 10, which lets
you enter a login and password for accessing the server. It's good practice not to enter
a password since the data is stored as plain text in "registrymodifications.xcu" in
Office's user configuration directory (often the folder
<span class="arithmatex">\(APPDATA\)</span>\LibreOffice\??\user). It's safer to pass the password to
Mail.mergeTask() at run time, as I've done in Mail.mergeEmail().</p>
<p>mergeEmail() calls Mail.checkMailConfig() to check if the mail server address, port
number, username, and password can be found in "registrymodifications.xcu". If the
first three aren't present then checkMailConfig() returns false and the merge is
aborted. If the password is found, then a stern warning message is printed, but
merging continues.</p>
<p>checkMailConfig() calls Info.getRegItemProp() which uses XPath to search through
"registrymodifications.xcu" for the specified property names and values.</p>
<h3 id="64-mergetask-implementing-mail-merging">6.4.  mergeTask(): Implementing Mail Merging<a class="headerlink" href="#64-mergetask-implementing-mail-merging" title="Permanent link">&para;</a></h3>
<p>mergeTask() is an expanded version of the code snippet given above which creates an
XJob instance, sets properties in the MailMerge service, and calls XJob.execute().</p>
<p>The properties settings are spread across if-tests which determine if the task involves
file creation, printing, or e-mail. Also, a listener is attached to the merge process. The
mergeTask() code:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// in the Mail class</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">mergeTask</span><span class="p">(</span><span class="n">String</span> <span class="n">dataSourceName</span><span class="p">,</span>
                               <span class="n">String</span> <span class="n">tableName</span><span class="p">,</span>
                               <span class="n">String</span> <span class="n">templateFnm</span><span class="p">,</span>
         <span class="kt">short</span> <span class="n">outputType</span><span class="p">,</span> <span class="kt">boolean</span> <span class="n">isSingle</span><span class="p">,</span>           <span class="c1">// for FILE</span>
         <span class="n">String</span> <span class="n">printerName</span><span class="p">,</span> <span class="kt">boolean</span> <span class="n">isMultipleJobs</span><span class="p">,</span>   <span class="c1">// for PRINTER</span>
         <span class="n">String</span> <span class="n">passwd</span><span class="p">,</span> <span class="n">String</span> <span class="n">subject</span><span class="p">,</span> <span class="n">String</span> <span class="n">body</span><span class="p">)</span>   <span class="c1">// for MAIL</span>
<span class="p">{</span>
  <span class="n">XJob</span> <span class="n">job</span> <span class="o">=</span> <span class="n">Lo</span><span class="p">.</span><span class="na">createInstanceMCF</span><span class="p">(</span><span class="n">XJob</span><span class="p">.</span><span class="na">class</span><span class="p">,</span>
                          <span class="s">&quot;com.sun.star.text.MailMerge&quot;</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">job</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Could not create MailMerge service&quot;</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">XPropertySet</span> <span class="n">props</span> <span class="o">=</span> <span class="n">Lo</span><span class="p">.</span><span class="na">qi</span><span class="p">(</span><span class="n">XPropertySet</span><span class="p">.</span><span class="na">class</span><span class="p">,</span> <span class="n">job</span><span class="p">);</span>

  <span class="c1">// standard task properties</span>
  <span class="n">Props</span><span class="p">.</span><span class="na">setProperty</span><span class="p">(</span><span class="n">props</span><span class="p">,</span> <span class="s">&quot;DataSourceName&quot;</span><span class="p">,</span> <span class="n">dataSourceName</span><span class="p">);</span>
  <span class="n">Props</span><span class="p">.</span><span class="na">setProperty</span><span class="p">(</span><span class="n">props</span><span class="p">,</span> <span class="s">&quot;Command&quot;</span><span class="p">,</span> <span class="n">tableName</span><span class="p">);</span>
  <span class="n">Props</span><span class="p">.</span><span class="na">setProperty</span><span class="p">(</span><span class="n">props</span><span class="p">,</span> <span class="s">&quot;CommandType&quot;</span><span class="p">,</span> <span class="n">CommandType</span><span class="p">.</span><span class="na">TABLE</span><span class="p">);</span>
  <span class="n">Props</span><span class="p">.</span><span class="na">setProperty</span><span class="p">(</span><span class="n">props</span><span class="p">,</span> <span class="s">&quot;DocumentURL&quot;</span><span class="p">,</span>
                                <span class="n">FileIO</span><span class="p">.</span><span class="na">fnmToURL</span><span class="p">(</span><span class="n">templateFnm</span><span class="p">));</span>

  <span class="c1">// vary properties based on output type</span>
  <span class="n">Props</span><span class="p">.</span><span class="na">setProperty</span><span class="p">(</span><span class="n">props</span><span class="p">,</span> <span class="s">&quot;OutputType&quot;</span><span class="p">,</span> <span class="n">outputType</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">outputType</span> <span class="o">==</span> <span class="n">MailMergeType</span><span class="p">.</span><span class="na">FILE</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Props</span><span class="p">.</span><span class="na">setProperty</span><span class="p">(</span><span class="n">props</span><span class="p">,</span> <span class="s">&quot;SaveAsSingleFile&quot;</span><span class="p">,</span> <span class="n">isSingle</span><span class="p">);</span>
    <span class="n">Props</span><span class="p">.</span><span class="na">setProperty</span><span class="p">(</span><span class="n">props</span><span class="p">,</span> <span class="s">&quot;FileNamePrefix&quot;</span><span class="p">,</span> <span class="s">&quot;letter&quot;</span><span class="p">);</span>
                                      <span class="c1">// hardwired filename</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">outputType</span> <span class="o">==</span> <span class="n">MailMergeType</span><span class="p">.</span><span class="na">PRINTER</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Props</span><span class="p">.</span><span class="na">setProperty</span><span class="p">(</span><span class="n">props</span><span class="p">,</span> <span class="s">&quot;SinglePrintJobs&quot;</span><span class="p">,</span> <span class="n">isMultipleJobs</span><span class="p">);</span>
                      <span class="c1">// true means one print job for each letter</span>
    <span class="n">PropertyValue</span><span class="o">[]</span> <span class="n">pProps</span> <span class="o">=</span>
       <span class="n">Props</span><span class="p">.</span><span class="na">makeProps</span><span class="p">(</span><span class="s">&quot;PrinterName&quot;</span><span class="p">,</span> <span class="n">printerName</span><span class="p">,</span> <span class="s">&quot;Wait&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
                                        <span class="c1">//  synchronous printing</span>
           <span class="c1">// from com.sun.star.view.PrintOptions</span>
    <span class="n">Props</span><span class="p">.</span><span class="na">setProperty</span><span class="p">(</span><span class="n">props</span><span class="p">,</span> <span class="s">&quot;PrintOptions&quot;</span><span class="p">,</span> <span class="n">pProps</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">outputType</span> <span class="o">==</span> <span class="n">MailMergeType</span><span class="p">.</span><span class="na">MAIL</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">passwd</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span>
      <span class="n">Props</span><span class="p">.</span><span class="na">setProperty</span><span class="p">(</span><span class="n">props</span><span class="p">,</span> <span class="s">&quot;OutServerPassword&quot;</span><span class="p">,</span> <span class="n">passwd</span><span class="p">);</span>

    <span class="n">Props</span><span class="p">.</span><span class="na">setProperty</span><span class="p">(</span><span class="n">props</span><span class="p">,</span> <span class="s">&quot;AddressFromColumn&quot;</span><span class="p">,</span> <span class="s">&quot;E-mail&quot;</span><span class="p">);</span>
                                      <span class="c1">// hardwired column name</span>
    <span class="n">Props</span><span class="p">.</span><span class="na">setProperty</span><span class="p">(</span><span class="n">props</span><span class="p">,</span> <span class="s">&quot;Subject&quot;</span><span class="p">,</span> <span class="n">subject</span><span class="p">);</span>
    <span class="n">Props</span><span class="p">.</span><span class="na">setProperty</span><span class="p">(</span><span class="n">props</span><span class="p">,</span> <span class="s">&quot;MailBody&quot;</span><span class="p">,</span> <span class="n">body</span><span class="p">);</span>

    <span class="n">Props</span><span class="p">.</span><span class="na">setProperty</span><span class="p">(</span><span class="n">props</span><span class="p">,</span> <span class="s">&quot;SendAsAttachment&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
    <span class="n">Props</span><span class="p">.</span><span class="na">setProperty</span><span class="p">(</span><span class="n">props</span><span class="p">,</span> <span class="s">&quot;AttachmentName&quot;</span><span class="p">,</span> <span class="s">&quot;letter.pdf&quot;</span><span class="p">);</span>
                                    <span class="c1">// hardwired filename and type</span>
    <span class="n">Props</span><span class="p">.</span><span class="na">setProperty</span><span class="p">(</span><span class="n">props</span><span class="p">,</span> <span class="s">&quot;AttachmentFilter&quot;</span><span class="p">,</span>
                                       <span class="s">&quot;writer_pdf_Export&quot;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// monitor task&#39;s execution</span>
  <span class="n">XMailMergeBroadcaster</span> <span class="n">xmmb</span> <span class="o">=</span>
                       <span class="n">Lo</span><span class="p">.</span><span class="na">qi</span><span class="p">(</span><span class="n">XMailMergeBroadcaster</span><span class="p">.</span><span class="na">class</span><span class="p">,</span> <span class="n">job</span><span class="p">);</span>
  <span class="n">xmmb</span><span class="p">.</span><span class="na">addMailMergeEventListener</span><span class="p">(</span> <span class="k">new</span> <span class="n">XMailMergeListener</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">long</span> <span class="n">start</span> <span class="o">=</span> <span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">notifyMailMergeEvent</span><span class="p">(</span><span class="n">MailMergeEvent</span> <span class="n">e</span><span class="p">)</span>
    <span class="p">{</span> <span class="n">count</span><span class="o">++</span><span class="p">;</span>
      <span class="n">XModel</span> <span class="n">model</span> <span class="o">=</span> <span class="n">e</span><span class="p">.</span><span class="na">Model</span><span class="p">;</span>
      <span class="c1">// Props.showProps(&quot;Mail merge event&quot;, model.getArgs());</span>
      <span class="kt">long</span> <span class="n">currTime</span> <span class="o">=</span> <span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span>
      <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;  Letter &quot;</span> <span class="o">+</span> <span class="n">count</span> <span class="o">+</span> <span class="s">&quot;: &quot;</span> <span class="o">+</span>
                                <span class="p">(</span><span class="n">currTime</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;ms&quot;</span><span class="p">);</span>
      <span class="n">start</span> <span class="o">=</span> <span class="n">currTime</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">});</span>

  <span class="k">try</span> <span class="p">{</span>
    <span class="n">job</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="k">new</span> <span class="n">NamedValue</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">catch</span> <span class="p">(</span><span class="n">com</span><span class="p">.</span><span class="na">sun</span><span class="p">.</span><span class="na">star</span><span class="p">.</span><span class="na">uno</span><span class="p">.</span><span class="na">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Could not start executing task: &quot;</span> <span class="o">+</span> <span class="n">e</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>  <span class="c1">// end of mergeTask()</span>
</code></pre></div>
<p>There are four properties that are always set:</p>
<div class="highlight"><pre><span></span><code><span class="n">Props</span><span class="p">.</span><span class="na">setProperty</span><span class="p">(</span><span class="n">props</span><span class="p">,</span> <span class="s">&quot;DataSourceName&quot;</span><span class="p">,</span> <span class="n">dataSourceName</span><span class="p">);</span>
<span class="n">Props</span><span class="p">.</span><span class="na">setProperty</span><span class="p">(</span><span class="n">props</span><span class="p">,</span> <span class="s">&quot;Command&quot;</span><span class="p">,</span> <span class="n">tableName</span><span class="p">);</span>
<span class="n">Props</span><span class="p">.</span><span class="na">setProperty</span><span class="p">(</span><span class="n">props</span><span class="p">,</span> <span class="s">&quot;CommandType&quot;</span><span class="p">,</span> <span class="n">CommandType</span><span class="p">.</span><span class="na">TABLE</span><span class="p">);</span>
<span class="n">Props</span><span class="p">.</span><span class="na">setProperty</span><span class="p">(</span><span class="n">props</span><span class="p">,</span> <span class="s">&quot;DocumentURL&quot;</span><span class="p">,</span>
                              <span class="n">FileIO</span><span class="p">.</span><span class="na">fnmToURL</span><span class="p">(</span><span class="n">templateFnm</span><span class="p">));</span>
</code></pre></div>
<p>These specify the use of a spreadsheet table, the data source name, and the template
filename (as a URI).</p>
<p>The other properties are divided up based on the MailMergeType constants FILE,
PRINT, and MAIL (see <code>lodoc MailMergeType</code>).</p>
<p>I've hardwired certain properties to reduce the number of arguments that need to be
passed to Mail.mergeLetter(), Mail.mergePrint(), and Mail.mergeEmail().</p>
<p>The listener implements the XMailMergeListener interface, and is attached through
XMailMergeBroadcaster. notifyMailMergeEvent() is called each time a new letter is
created. For my addresses.ods spreadsheet, it's triggered six times since there are six
rows of data (see Figure 6).</p>
<p>notifyMailMergeEvent() prints only timing information for each letter task, but more
details could be obtained by accessing the event's model.</p>
<h3 id="65-mail-merge-reliability">6.5.  Mail Merge Reliability<a class="headerlink" href="#65-mail-merge-reliability" title="Permanent link">&para;</a></h3>
<p>Office's  mail merge wizard, which implements the "Office API" parts of Figure 5,
and so corresponds to my Mail.mergeTask()function, has a long history of crashing.</p>
<p>Mail.mergeTask() has always worked fine in my tests, except that it displays a
"LibreOffice has stopped working" error dialog after terminating. However, no
zombie Office processes are left over, so the dialog can be safely ignored and closed.</p>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="41-Printing.html" class="md-footer__link md-footer__link--prev" aria-label="Previous: Chapter 41. Printing" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Chapter 41. Printing
            </div>
          </div>
        </a>
      
      
        
        <a href="43-Using_the_Clipboard.html" class="md-footer__link md-footer__link--next" aria-label="Next: Chapter 43. Using the Clipboard" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Chapter 43. Using the Clipboard
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        
          Made with
          <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
            Material for MkDocs
          </a>
        
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": ".", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "assets/javascripts/workers/search.8397ff9e.min.js", "version": null}</script>
    
    
      <script src="assets/javascripts/bundle.1e84347e.min.js"></script>
      
    
  </body>
</html>